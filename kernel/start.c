#include "klib.h"
#include "global.h"
#include "proc.h"
#include "types.h"
#include "x86def.h"
#include "handler.h"
#include "asm.h"

void relocate_gdt() {
    gain_gdt();
    u16 *p_gdt_limit = (u16 *)(&gdt_ptr[0]);
    u32 *p_gdt_base = (u32 *)(&gdt_ptr[2]);
    memcpy(gdt, (void *)(*p_gdt_base), (size_t)p_gdt_limit + 1); // why &gdt
    *p_gdt_limit = GDT_SIZE * sizeof(DESCRIPTOR) - 1;
    *p_gdt_base = (u32)&gdt;
    apply_gdt();
}

void add_ldt_desc() {
    // LDTs for each task
    PROCESS *p_proc = proc_table;
    u16 index_ldt = INDEX_LDT_FIRST;
    for (int i = 0; i < NR_TASKS; i++, p_proc++, index_ldt++) {
        init_descriptor(
            &gdt[index_ldt],
            vir2phys(seg2phys(SELECTOR_KERNEL_DS), proc_table[i].ldts),
            LDT_SIZE * sizeof(DESCRIPTOR) - 1, DA_LDT);
    }
}

void add_tss_desc() {
    // Add TSS descriptor to gdt[INDEX_TSS]
    memset(&tss, 0, sizeof(tss));
    tss.ss0 = SELECTOR_KERNEL_DS;
    init_descriptor(&gdt[INDEX_TSS],
                    vir2phys(seg2phys(SELECTOR_KERNEL_DS), &tss),
                    sizeof(TSS) - 1, DA_386TSS);
    tss.iobase = sizeof(tss);
}

void init_idt() {
    // 初始化中断重入计数器
    k_reenter = -1;
    // 初始化中断门
    int i;
    for (i = 0; i < IDT_SIZE; i++)
        init_gate(&idt[i], DA_386IGate, (void *)empty_handler, 0);
    // 设置时间中断和键盘中断
    init_gate(&idt[0x20], DA_386IGate, (void *)clock_handler, 0);
    // init_gate(&idt[0x21], DA_386IGate, (void*)KeyBoardHandler, 0);
    // 设置 idt_ptr
    u16 *p_idt_limit = (u16 *)(&idt_ptr[0]);
    u32 *p_idt_base = (u32 *)(&idt_ptr[2]);
    *p_idt_limit = IDT_SIZE * sizeof(GATE) - 1;
    *p_idt_base = (u32)&idt;
    // 设置 8259a
    set_8259a();
    // 设置 IMREG 开启键盘和定时器中断
    outb(0x21, 0xFE); // 主 <= OCW1
    outb(0xA1, 0xFF); // 从 <= OCW1
    // 加载 idt 并开启中断
    apply_idt();
}

void kernel_start() {
    // 清屏
    disp_clear();
    // 显示超级马里奥
    char SUPER_MARIO[1200] = {
        32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 42, 42,
        42, 42, 42, 42, 42, 42, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 10, 32,
        32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35,
        46, 46, 46, 46, 35, 46, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 35, 46, 46, 35, 35, 35, 46, 46, 46, 46, 46, 35, 35, 46, 46, 46,
        46, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35,
        46, 46, 46, 46, 46, 46, 46, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 32, 32, 35, 35, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46,
        46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46,
        46, 46, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 46, 35,
        10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35,
        42, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 32, 32, 32, 35, 46, 35, 46, 35, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 35, 46, 35, 46, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 35, 35, 35, 35, 42, 42, 42, 42, 42, 42, 42, 35, 35, 35,
        35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46,
        35, 46, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 35, 46, 35,
        10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 35, 42, 42,
        42, 46, 42, 42, 42, 42, 46, 42, 35, 35, 35, 46, 46, 46, 46, 32, 32, 32,
        32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 46, 35, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 32, 35, 46, 46, 46, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 32, 46, 46, 46, 46, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 35,
        35, 46, 46, 46, 46, 46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35,
        35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 10,
        32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 46, 42, 42, 42,
        42, 32, 32, 32, 32, 42, 42, 42, 42, 42, 46, 46, 46, 46, 10, 32, 32, 32,
        32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 32, 32, 32, 32,
        32, 32, 32, 32, 35, 35, 35, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32,
        32, 32, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35,
        35, 35, 35, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 10, 35, 46, 46, 46,
        35, 46, 46, 46, 46, 46, 46, 35, 46, 35, 35, 46, 46, 46, 35, 46, 46, 46,
        46, 46, 46, 35, 46, 35, 35, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35,
        46, 35, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45,
        45, 45, 45, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 45, 45, 45, 45, 45, 45,
        45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 46, 46, 35,
        46, 46, 46, 46, 35, 46, 46, 46, 46, 35, 35, 46, 46, 35, 46, 46, 46, 46,
        35, 46, 46, 46, 46, 35, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46,
        46, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 35, 45, 45,
        45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 46, 46, 46, 46, 46, 35, 46,
        46, 46, 46, 46, 46, 35, 35, 46, 46, 46, 46, 46, 35, 46, 46, 46, 46, 46,
        46, 35, 35, 46, 46, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 32, 32,
        32, 32, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 32, 32, 32, 32, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45,
        35, 10, 35, 46, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 35, 35, 46,
        35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 35, 35, 46, 35, 46, 46, 35,
        46, 46, 46, 46, 35, 46, 46, 35, 32, 32, 32, 32, 35, 45, 45, 45, 45, 45,
        45, 45, 45, 45, 45, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 35,
        35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 0};
    DispStr(SUPER_MARIO);
    DispStr("\n");
    // 设置 gdt
    relocate_gdt();
    add_ldt_desc();
    add_tss_desc();
    apply_tss(INDEX_TSS << 3);
    // 设置 idt
    init_idt();
    // show graphic for some time
    delay(3);
    // 进程
    init_proc();
    return;
}