#include "klib.h"
#include "global.h"
#include "type.h"
#include "protect.h"
#include "handler.h"

void relocate_gdt() {
    gain_gdt();
    u16* p_gdt_limit = (u16*)(&gdt_ptr[0]);
    u32* p_gdt_base = (u32*)(&gdt_ptr[2]);
    memcpy(gdt, (void*)(*p_gdt_base), (size_t)p_gdt_limit + 1); // why &gdt
    *p_gdt_limit = GDT_SIZE * sizeof(DESCRIPTOR) - 1;
	*p_gdt_base = (u32)&gdt;
    apply_gdt();
}

void init_idt() {
    // 初始化中断门
    int i;
    for(i = 0; i < IDT_SIZE; i++) init_gate(&idt[i], DA_386IGate, (void*)empty_handler, PRIVILEGE_KRNL);
    // 设置时间中断和键盘中断
    init_gate(&idt[0x20], DA_386IGate, (void*)clock_handler, PRIVILEGE_KRNL);
    init_gate(&idt[0x21], DA_386IGate, (void*)KeyBoardHandler, PRIVILEGE_KRNL);
    // 设置 idt_ptr
    u16* p_idt_limit = (u16*)(&idt_ptr[0]);
    u32* p_idt_base = (u32*)(&idt_ptr[2]);
    *p_idt_limit = IDT_SIZE * sizeof(GATE) - 1;
    *p_idt_base = (u32)&idt;
    // 设置 8259a
    set_8259a();
    // 设置 IMREG 开启键盘和定时器中断
    out_byte(0x21, 0xFC); // 主 <= OCW1
    out_byte(0xA1, 0xFF); // 从 <= OCW1 
    // 加载 idt 并开启中断
    apply_idt();
}

void kernel_start() {
    // 清屏
    disp_clear();
    // 显示超级马里奥
    char SUPER_MARIO[1200] = {32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 42, 42, 42, 42, 42, 42, 42, 42, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 46, 46, 46, 46, 35, 46, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 35, 35, 35, 46, 46, 46, 46, 46, 35, 35, 46, 46, 46, 46, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 46, 46, 46, 46, 46, 46, 46, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 46, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 46, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 42, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 35, 46, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 35, 46, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 42, 42, 42, 42, 42, 42, 42, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 35, 46, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 35, 46, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 35, 42, 42, 42, 46, 42, 42, 42, 42, 46, 42, 35, 35, 35, 46, 46, 46, 46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 46, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 46, 46, 46, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 46, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 35, 35, 46, 46, 46, 46, 46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 46, 46, 46, 46, 42, 42, 42, 42, 32, 32, 32, 32, 42, 42, 42, 42, 42, 46, 46, 46, 46, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 32, 32, 32, 32, 35, 35, 35, 35, 35, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 10, 35, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 46, 35, 35, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 46, 35, 35, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 46, 35, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46, 46, 35, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46, 46, 35, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46, 46, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 46, 46, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 35, 46, 46, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 35, 46, 46, 46, 46, 46, 35, 46, 46, 46, 46, 46, 46, 35, 32, 32, 32, 32, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 46, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 35, 35, 46, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 35, 35, 46, 35, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 35, 32, 32, 32, 32, 35, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 35, 10, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 32, 32, 32, 32, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 0};
    DispStr(SUPER_MARIO);
    DispStr("\n");
    // 设置 gdt
    relocate_gdt();
    // 设置 idt
    init_idt();
    // finish
    return;
}